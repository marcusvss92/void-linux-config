# doas configuration for multi-user pentesting setup
# Place in /etc/doas.conf

# ============= CONFIGURAÇÃO BÁSICA =============

# Permitir usuários do grupo wheel com senha
# permit :wheel

# Opcional: Permitir usuários do grupo wheel serem persistentes com senha (5 minutos)
# permit persist :wheel

# ============= USUÁRIO PRINCIPAL (mvinicius) =============

# Acesso total com senha
permit mvinicius as root

# Comandos básicos sem senha
permit nopass mvinicius as root cmd /bin/mount
permit nopass mvinicius as root cmd /bin/umount

# Controle do sistema
# permit nopass mvinicius as root cmd /usr/bin/systemctl args reboot
# permit nopass mvinicius as root cmd /usr/bin/systemctl args poweroff
# permit nopass mvinicius as root cmd /usr/bin/systemctl args suspend
# permit nopass mvinicius as root cmd /usr/bin/systemctl args hibernate

# Gerenciamento de redes (serviços específicos)
permit nopass mvinicius as root cmd /usr/bin/sv args up NetworkManager
permit nopass mvinicius as root cmd /usr/bin/sv args down NetworkManager
permit nopass mvinicius as root cmd /usr/bin/sv args restart NetworkManager

# Package management operations (require password for security)
permit :wheel as root cmd /usr/bin/xbps-install
permit :wheel as root cmd /usr/bin/xbps-remove
permit :wheel as root cmd /usr/bin/xbps-query

# Permitir trocar para outros usuários
permit nopass mvinicius as pentester
permit nopass mvinicius as developer
permit nopass mvinicius as sandbox

# NEGAR comandos perigosos
deny mvinicius as root cmd /bin/rm args -rf /*

# ============= USUÁRIO PENTESTING (pentester) =============

# Ferramentas de rede sem senha
permit nopass pentester as root cmd /usr/bin/nmap
permit nopass pentester as root cmd /usr/bin/masscan
permit nopass pentester as root cmd /usr/bin/zmap

# Monitoramento de rede
permit nopass pentester as root cmd /usr/bin/tcpdump
permit nopass pentester as root cmd /usr/bin/tshark
permit nopass pentester as root cmd /usr/bin/wireshark

# Wireless hacking
permit nopass pentester as root cmd /usr/bin/airmon-ng
permit nopass pentester as root cmd /usr/bin/airodump-ng
permit nopass pentester as root cmd /usr/bin/aireplay-ng
permit nopass pentester as root cmd /usr/bin/aircrack-ng

# Metasploit database
permit nopass pentester as root cmd /opt/metasploit/msfdb

# Hardware hacking (USB, serial)
permit nopass pentester as root cmd /bin/dmesg
permit nopass pentester as root cmd /usr/bin/lsusb
permit nopass pentester as root cmd /usr/sbin/setserial

# Monitoramento do sistema
permit nopass pentester as root cmd /usr/bin/netstat
permit nopass pentester as root cmd /bin/ss
permit nopass pentester as root cmd /usr/bin/lsof

# NEGAR comandos perigosos
deny pentester as root cmd /bin/rm args -rf /*
deny pentester as root cmd /usr/bin/dd
deny pentester as root cmd /sbin/mkfs.*

# ============= USUÁRIO DESENVOLVIMENTO (developer) =============

# Docker sem senha
permit nopass developer as root cmd /usr/bin/docker
permit nopass developer as root cmd /usr/bin/docker-compose

# Desenvolvimento web
# permit nopass developer as root cmd /usr/bin/systemctl args start nginx
# permit nopass developer as root cmd /usr/bin/systemctl args stop nginx
# permit nopass developer as root cmd /usr/bin/systemctl args restart nginx

# Banco de dados
# permit nopass developer as root cmd /usr/bin/systemctl args start postgresql
# permit nopass developer as root cmd /usr/bin/systemctl args stop postgresql

# VirtualBox
permit nopass developer as root cmd /usr/bin/VBoxManage

# NEGAR acesso a ferramentas de pentesting
deny developer as root cmd /usr/bin/nmap
deny developer as root cmd /usr/bin/tcpdump
deny developer as root cmd /usr/bin/nmap
deny developer as root cmd /usr/bin/masscan
deny developer as root cmd /usr/bin/zmap
deny developer as root cmd /usr/bin/tcpdump
deny developer as root cmd /usr/bin/tshark
deny developer as root cmd /usr/bin/wireshark
deny developer as root cmd /usr/bin/airmon-ng
deny developer as root cmd /usr/bin/airodump-ng
deny developer as root cmd /usr/bin/aireplay-ng
deny developer as root cmd /opt/metasploit/msfdb
deny developer as root cmd /bin/dmesg
deny developer as root cmd /usr/bin/lsusb
deny developer as root cmd /usr/sbin/setserial

# ============= USUÁRIO SANDBOX (sandbox) =============

# Acesso mínimo - apenas comandos básicos
permit sandbox as root cmd /bin/mount args /tmp/*
permit sandbox as root cmd /bin/umount args /tmp/*

# NEGAR tudo mais
deny sandbox as root
deny sandbox as pentester
deny sandbox as developer
deny sandbox as mvinicius

# ============= CUSTOM SCRIPTS =============

# Allow custom pentesting scripts without password
permit nopass :wheel as root cmd /usr/local/bin/pentest-workspace-setup.sh
permit nopass :wheel as root cmd /usr/local/bin/update-efi-entry.sh
permit nopass :wheel as root cmd /usr/local/bin/get-resume-offset.sh
permit nopass :wheel as root cmd /usr/local/bin/monitor-nonfree-compliance.sh

# Metasploit database management
permit nopass :wheel as root cmd /opt/metasploit/msfdb

# ============= SECURITY RESTRICTIONS =============

# Explicitly deny dangerous commands
deny :wheel as root cmd /bin/rm args -rf /*
deny :wheel as root cmd /usr/bin/dd args if=* of=/dev/sd*
deny :wheel as root cmd /usr/bin/shred args *
deny :wheel as root cmd /bin/mkfs.*

# Deny access to sensitive files
deny :wheel as root cmd /bin/cat args /etc/shadow
deny :wheel as root cmd /bin/cat args /etc/gshadow

# ============= LOGGING =============

# Log all doas usage (uncomment if you want logging)
permit persist :wheel log

# ============= EXAMPLES FOR CUSTOMIZATION =============

# Uncomment and modify as needed:

# Allow specific user without password for everything (DANGEROUS)
# permit nopass username as root

# Allow specific commands for specific users
# permit nopass username as root cmd /path/to/specific/command

# Allow running as different user
# permit :wheel as postgres cmd /usr/bin/createdb

# Time-limited permissions
# permit :wheel as root cmd /usr/bin/some-command env { timeout=3600 }

# ============= NOTES =============

# - Lines starting with # are comments
# - Order matters: first matching rule wins
# - Use 'doas -C /etc/doas.conf' to check syntax
# - Test configuration before logging out
# - 'permit persist' caches authentication for 5 minutes
# - 'permit nopass' allows command without password
# - Always test dangerous configurations in a VM first

# ============= USEFUL COMMANDS =============

# Check doas configuration:
# doas -C /etc/doas.conf

# Test a command:
# doas whoami

#!/bin/bash
# /usr/local/bin/setup-pentesting-graphics-powersave.sh

echo "=== Configuração Gráfica + Economia de Energia ==="

# 1. Instalar drivers básicos
echo "Instalando drivers básicos..."
doas xbps-install -S nvidia nvidia-libs nvidia-opencl mesa-dri

# 2. Configurar modprobe com economia de energia
echo "Configurando drivers com power saving..."
doas tee /etc/modprobe.d/nvidia.conf << 'EOF'
# NVIDIA básico para pentesting
options nvidia_drm modeset=1

# ECONOMIA DE ENERGIA MÁXIMA
options nvidia NVreg_DynamicPowerManagement=0x02
options nvidia NVreg_PowerMizerEnable=1
options nvidia NVreg_PowerMizerDefault=0x3
options nvidia NVreg_PowerMizerDefaultAC=0x3

# Desabilitar GSP (economia extra)
options nvidia NVreg_EnableGpuFirmware=0

# Blacklist nouveau
blacklist nouveau
EOF

# 3. Configurar dracut
echo "add_drivers+=\" nvidia nvidia_modeset nvidia_drm i915 \"" | doas tee /etc/dracut.conf.d/60-graphics.conf

# 4. Configurar power management via udev
doas tee /etc/udev/rules.d/80-nvidia-pm.conf << 'EOF'
# Colocar GPU NVIDIA em power save por padrão
SUBSYSTEM=="pci", ATTR{vendor}=="0x10de", ATTR{class}=="0x030000", TEST=="power/control", ATTR{power/control}="auto"
SUBSYSTEM=="pci", ATTR{vendor}=="0x10de", ATTR{class}=="0x030200", TEST=="power/control", ATTR{power/control}="auto"
EOF

# 5. Criar scripts de controle da GPU
create_gpu_control_scripts

# 6. Configurar systemd sleep hooks (se disponível)
setup_sleep_hooks

echo "✅ Configuração com economia de energia concluída!"

#!/bin/bash
# Wrapper to run applications in NVIDIA and power off the GPU after

if [ $# -eq 0 ]; then
    echo "Usage: nvidia-run <command> [arguments...]"
    exit 1
fi

# Power on the GPU NVIDIA via bbswitch
if [ -w /proc/acpi/bbswitch ]; then
    echo ON | doas tee /proc/acpi/bbswitch > /dev/null
fi

# Set up the PRIME Render Offload variables
export __NV_PRIME_RENDER_OFFLOAD=1
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export __VK_LAYER_NV_optimus=NVIDIA_only

# For OpenGL programs, use primusrun if available
if command -v primusrun >/dev/null 2>&1; then
    primusrun "$@"
else
    "$@"
fi

RET=$?

# Power off the GPU NVIDIA after closing a program
if [ -w /proc/acpi/bbswitch ]; then
    echo OFF | doas tee /proc/acpi/bbswitch > /dev/null
fi

exit $RET
